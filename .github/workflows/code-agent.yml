name: Code Agent Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-analysis:
    runs-on: ubuntu-latest
    name: Analyze Code with AI Agent
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Run Code Agent
        uses: potproject/code-agent@v0.2.2
        with:
          # –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏–π
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
          # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          # model: 'gpt-4' # –∏–ª–∏ 'gpt-3.5-turbo'
          # temperature: 0.7
          # max_tokens: 2000
          
          # –¢–∏–ø—ã –∞–Ω–∞–ª–∏–∑–∞
          analyze_security: true
          analyze_performance: true
          analyze_best_practices: true
          analyze_documentation: true
          
          # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
          auto_fix: false # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ true –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö PR —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
          
          # –§–∏–ª—å—Ç—Ä—ã —Ñ–∞–π–ª–æ–≤
          include_patterns: |
            **/*.js
            **/*.jsx
            **/*.ts
            **/*.tsx
            **/*.json
            **/*.yml
            **/*.yaml
          
          exclude_patterns: |
            node_modules/**
            .next/**
            build/**
            dist/**
            coverage/**
            **/*.min.js
            **/*.test.js
            **/*.spec.js
          
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
          comment_on_pr: true
          create_issues: true
          severity_threshold: 'medium' # low, medium, high
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
          custom_rules: |
            - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 'use client' –¥–∏—Ä–µ–∫—Ç–∏–≤—ã –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
            - –£–±–µ–¥–∏—Ç—å—Å—è –≤ –Ω–∞–ª–∏—á–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
            - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π Next.js
            - –í–∞–ª–∏–¥–∞—Ü–∏—è TypeScript —Ç–∏–ø–æ–≤
            - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (a11y)
            - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è bundle size
            - –ü—Ä–æ–≤–µ—Ä–∫–∞ SEO –º–µ—Ç–∞-—Ç–µ–≥–æ–≤
            - –í–∞–ª–∏–¥–∞—Ü–∏—è API endpoints
            - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ JWT
            - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è React —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
          
          # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
          ignore_issues: |
            - console.log –≤ development —Ä–µ–∂–∏–º–µ
            - TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            - –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ Next.js features
      
      - name: Upload Analysis Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis-report
          path: |
            code-agent-report.json
            code-agent-report.html
          retention-days: 30
      
      - name: Check Analysis Results
        run: |
          if [ -f "code-agent-report.json" ]; then
            echo "üìä Code Analysis Complete"
            echo "=============================="
            cat code-agent-report.json | jq '.summary'
          fi

  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è job –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º
  critical-issues:
    needs: code-analysis
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Create Critical Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Critical Code Issues Found',
              body: `Code Agent –æ–±–Ω–∞—Ä—É–∂–∏–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ.
              
              **Commit:** ${context.sha}
              **Branch:** ${context.ref}
              **Workflow:** ${context.workflow}
              
              –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ [—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`,
              labels: ['critical', 'code-quality', 'automated']
            });