import { NextResponse } from 'next/server';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { withRateLimit } from '../../middleware/rateLimit';

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è API –∫–ª—é—á–∞
const GEMINI_API_KEY = process.env.GOOGLE_GEMINI_API_KEY;
if (!GEMINI_API_KEY) {
  console.error('GOOGLE_GEMINI_API_KEY is not set in environment variables');
}

const genAI = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null;

const KNOWLEDGE_BASE = `
  –¢—ã - –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä –∫–æ–º–ø–∞–Ω–∏–∏ NeuroExpert —Å 7-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å–∞.
  
  –¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
  - –ò–º—è: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ù–µ–π—Ä–æ–Ω–æ–≤
  - –û–ø—ã—Ç: 7 –ª–µ—Ç –≤ —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–∏, 300+ —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
  - –°—Ç–∏–ª—å: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.
  - –ü–æ–¥—Ö–æ–¥: –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ —Ü–∏—Ñ—Ä—ã, –∞ –Ω–µ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã
  
  –ü–†–ò–ù–¶–ò–ü–´ –û–¢–í–ï–¢–û–í:
  1. –ù–∞—á–∏–Ω–∞–π —Å –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
  2. –ü—Ä–µ–¥–ª–∞–≥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
  3. –ü—Ä–∏–≤–æ–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Å—Ä–æ–∫–∏
  4. –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (–∫–µ–π—Å—ã)
  5. –ó–∞–∫–∞–Ω—á–∏–≤–∞–π —á–µ—Ç–∫–∏–º –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é
  
  –®–ê–ë–õ–û–ù–´ –£–ú–ù–´–• –û–¢–í–ï–¢–û–í:
  
  –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Ü–µ–Ω–µ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
  "–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–π –∑–∞–¥–∞—á–∏. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–æ–π —É –≤–∞—Å –±–∏–∑–Ω–µ—Å? 
  
  –ù–∞–ø—Ä–∏–º–µ—Ä:
  ‚Ä¢ –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã? Landing + AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞ 79 900‚ÇΩ –æ–∫—É–ø–∏—Ç—Å—è –∑–∞ 2 –º–µ—Å—è—Ü–∞
  ‚Ä¢ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω? –ì–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –æ—Ç 149 900‚ÇΩ —É–≤–µ–ª–∏—á–∏—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏—é –Ω–∞ 40%
  ‚Ä¢ B2B –∫–æ–º–ø–∞–Ω–∏—è? CRM —Å AI-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –æ—Ç 199 900‚ÇΩ —É–¥–≤–æ–∏—Ç –ø—Ä–æ–¥–∞–∂–∏
  
  –ö–∞–∫–∞—è —Å—Ñ–µ—Ä–∞ —É –≤–∞—Å?"
  
  –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å—Ä–æ–∫–∞—Ö:
  "‚ö° –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã —Ä–µ–∫–æ—Ä–¥–Ω–æ –±—ã—Å—Ç—Ä–æ:
  ‚Ä¢ Landing page: 5-7 –¥–Ω–µ–π (–æ–±—ã—á–Ω–æ —É –¥—Ä—É–≥–∏—Ö 3-4 –Ω–µ–¥–µ–ª–∏)
  ‚Ä¢ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω: 14 –¥–Ω–µ–π (—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ 2-3 –º–µ—Å—è—Ü–∞)
  ‚Ä¢ –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: 21 –¥–µ–Ω—å (—Å—Ç–∞–Ω–¥–∞—Ä—Ç —Ä—ã–Ω–∫–∞ 3-6 –º–µ—Å—è—Ü–µ–≤)
  
  –°–µ–∫—Ä–µ—Ç –≤ –Ω–∞—à–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –≥–æ—Ç–æ–≤—ã—Ö AI-–º–æ–¥—É–ª–µ–π. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞–º –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å?"
  
  –ù–ê–®–ò –†–ï–®–ï–ù–ò–Ø –ò –¢–ï–•–ù–û–õ–û–ì–ò–ò:
  
  –†–ê–ó–†–ê–ë–û–¢–ö–ê –ü–û–î –ö–õ–Æ–ß:
  
  1. –ò–ù–¢–ï–†–ù–ï–¢-–ú–ê–ì–ê–ó–ò–ù–´ –° AI (–æ—Ç 149 900‚ÇΩ):
     - AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∑–Ω–∞–µ—Ç –≤—Å—ë –æ —Ç–æ–≤–∞—Ä–∞—Ö
     - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–∞–∂–¥–æ–º—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
     - –ü–æ–º–æ—â—å –≤ –≤—ã–±–æ—Ä–µ —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
     - –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≥–æ–ª–æ—Å–æ–º
     - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏
     - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–°, –ú–æ–π–°–∫–ª–∞–¥
  
  2. –ú–û–ë–ò–õ–¨–ù–´–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–æ—Ç 299 900‚ÇΩ):
     - –ù–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è iOS –∏ Android
     - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
     - –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫
     - –£–º–Ω—ã–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
     - –†–∞–±–æ—Ç–∞ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ
     - –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ App Store –∏ Google Play
  
  3. LANDING PAGE –° AI (–æ—Ç 79 900‚ÇΩ):
     - –ö–æ–Ω–≤–µ—Ä—Å–∏—è –¥–æ 40%
     - AI –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ª–∏–¥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
     - A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤
     - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –Ω–∞ –≤—Å—Ç—Ä–µ—á—É
     - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM
     - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è
  
  4. –ö–û–†–ü–û–†–ê–¢–ò–í–ù–´–ï –°–ê–ô–¢–´ (–æ—Ç 199 900‚ÇΩ):
     - AI-–æ—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂ 24/7
     - –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
     - –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–∏
     - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
     - –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
     - White label —Ä–µ—à–µ–Ω–∏–µ
  
  5. –û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–´–ï –ü–õ–ê–¢–§–û–†–ú–´ (–æ—Ç 349 900‚ÇΩ):
     - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å
     - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø–æ–¥ —Å—Ç—É–¥–µ–Ω—Ç–∞
     - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π
     - –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è
     - –û—Ç—á–µ—Ç—ã –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π
     - –í–∏–¥–µ–æ–∫—É—Ä—Å—ã —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
  
  6. SAAS –ü–õ–ê–¢–§–û–†–ú–´ (–æ—Ç 499 900‚ÇΩ):
     - AI –≤ –æ—Å–Ω–æ–≤–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
     - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
     - API –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
     - –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É
     - –ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å
     - –ë–∏–ª–ª–∏–Ω–≥ –∏ –ø–æ–¥–ø–∏—Å–∫–∏
  
  –í–°–ï –ü–†–û–ï–ö–¢–´ –í–ö–õ–Æ–ß–ê–Æ–¢:
  ‚úì AI-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –æ–±—É—á–µ–Ω–Ω—ã–π –ø–æ–¥ –≤–∞—à –±–∏–∑–Ω–µ—Å
  ‚úì –ü–æ–ª–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ CRM —Ñ—É–Ω–∫—Ü–∏–∏
  ‚úì 3 –º–µ—Å—è—Ü–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ
  ‚úì –ó–∞–ø—É—Å–∫ –∑–∞ 2-4 –Ω–µ–¥–µ–ª–∏
  ‚úì –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
  
  –ù–ê–®–ò –¢–ï–•–ù–û–õ–û–ì–ò–ò:
  - Frontend: React, Next.js, React Native
  - Backend: Node.js, Python
  - AI: GPT-4, Claude 3, Gemini Pro
  - –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: PostgreSQL, MongoDB
  - –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: AWS, Google Cloud
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: –õ—é–±—ã–µ API –∏ CRM —Å–∏—Å—Ç–µ–º—ã
  
  –ö–û–ù–¢–ê–ö–¢–´:
  - –¢–µ–ª–µ—Ñ–æ–Ω: +7 (904) 047-63-83
  - Email: aineuroexpert@gmail.com
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞: 24/7 —á–µ—Ä–µ–∑ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
  
  –¢–ï–ö–£–©–ò–ï –¢–ê–†–ò–§–´:
  - –°—Ç–∞—Ä—Ç: 39,900‚ÇΩ/–º–µ—Å—è—Ü - –¥–æ 1000 –¥–∏–∞–ª–æ–≥–æ–≤
  - –ë–∏–∑–Ω–µ—Å: 89,900‚ÇΩ/–º–µ—Å—è—Ü - –¥–æ 10,000 –¥–∏–∞–ª–æ–≥–æ–≤
  - Enterprise: –æ—Ç 199,900‚ÇΩ/–º–µ—Å—è—Ü - –±–µ–∑–ª–∏–º–∏—Ç
`;

async function sendTelegramNotification(question, answer, model) {
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_SITE_URL || 'https://neuroexpert.onrender.com'}/api/telegram-notify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'ai_chat',
        data: {
          question,
          answer: answer.substring(0, 500) + (answer.length > 500 ? '...' : ''),
          model,
          timestamp: new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })
        }
      })
    });
    
    if (!response.ok) {
      console.error('Failed to send Telegram notification');
    }
  } catch (error) {
    console.error('Telegram notification error:', error);
  }
}

async function handler(request) {
  const startTime = Date.now();
  
  try {
    const { question, model = 'gemini' } = await request.json();
    
    console.log('Assistant API called:', { question, model });
    console.log('API Key present:', !!GEMINI_API_KEY);
    
    if (!question) {
      return NextResponse.json({ error: '–í–æ–ø—Ä–æ—Å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' }, { status: 400 });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Gemini API
    if ((model === 'gemini' || model === 'claude') && (!genAI || !GEMINI_API_KEY)) {
      console.error('Gemini API key is missing, falling back to demo mode');
      return NextResponse.json({ 
        answer: 'AI —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏: +7 (904) 047-63-83',
        model: 'demo',
        responseTime: Date.now() - startTime,
        warning: 'API key not configured'
      });
    }

    let answer;
    let usedModel = model;

    try {
      if (!process.env.GOOGLE_GEMINI_API_KEY) {
        console.error('GOOGLE_GEMINI_API_KEY not set - using demo mode');
        // Demo —Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const demoResponses = {
          '—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç': '–ù–∞—à–∏ —Ç–∞—Ä–∏—Ñ—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –æ—Ç 39,900‚ÇΩ/–º–µ—Å—è—Ü –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –¢–∞—Ä–∏—Ñ "–ë–∏–∑–Ω–µ—Å" —Å—Ç–æ–∏—Ç 89,900‚ÇΩ/–º–µ—Å—è—Ü –∏ –≤–∫–ª—é—á–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ –∏–ª–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞ —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º. –î–ª—è –∫—Ä—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (SaaS –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã) - –æ—Ç 199,900‚ÇΩ/–º–µ—Å—è—Ü.',
          '—á—Ç–æ —É–º–µ–µ—Ç–µ': '–ú—ã —Å–æ–∑–¥–∞–µ–º: –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—ã —Å AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞–º–∏, –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–∞–π—Ç—ã —Å AI-–æ—Ç–¥–µ–ª–æ–º –ø—Ä–æ–¥–∞–∂, –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º AI-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º, SaaS —Ä–µ—à–µ–Ω–∏—è. –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –≤–∫–ª—é—á–∞—é—Ç –æ–±—É—á–µ–Ω–Ω–æ–≥–æ –ø–æ–¥ –≤–∞—à –±–∏–∑–Ω–µ—Å AI-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.',
          '—Å—Ä–æ–∫–∏': '–ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 2-4 –Ω–µ–¥–µ–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏. Landing page - 2 –Ω–µ–¥–µ–ª–∏, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω - 3 –Ω–µ–¥–µ–ª–∏, –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - 4 –Ω–µ–¥–µ–ª–∏.',
          'default': '–Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç NeuroExpert. –ú—ã —Å–æ–∑–¥–∞–µ–º —Å–∞–π—Ç—ã, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—ã —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ AI-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º–∏. –•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –Ω–∞—à–∏—Ö —É—Å–ª—É–≥–∞—Ö?'
        };
        
        const lowerQuestion = question.toLowerCase();
        answer = demoResponses[Object.keys(demoResponses).find(key => lowerQuestion.includes(key))] || demoResponses.default;
        
      } else if (model === 'gemini') {
        const geminiModel = genAI.getGenerativeModel({ model: "gemini-pro" });
        
        const prompt = `${KNOWLEDGE_BASE}
        
–í–ê–ñ–ù–û: 
- –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä –ê–ª–µ–∫—Å–∞–Ω–¥—Ä
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ —Ü–∏—Ñ—Ä—ã
- –ë—É–¥—å –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–º - –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ—à–µ–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∑–∞ –≤–æ–ø—Ä–æ—Å–æ–º
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ø–æ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞

–í–û–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: ${question}

–¢–í–û–ô –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ (–∫–∞–∫ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ù–µ–π—Ä–æ–Ω–æ–≤):`;
        
        const result = await geminiModel.generateContent(prompt);
        const response = result.response;
        answer = response.text();
      } else if (model === 'claude' && process.env.ANTHROPIC_API_KEY) {
        // Claude API implementation would go here
        // For now, fallback to Gemini
        usedModel = 'gemini';
        const geminiModel = genAI.getGenerativeModel({ model: "gemini-pro" });
        const prompt = `${KNOWLEDGE_BASE}
        
–í–ê–ñ–ù–û: 
- –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä –ê–ª–µ–∫—Å–∞–Ω–¥—Ä
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ —Ü–∏—Ñ—Ä—ã
- –ë—É–¥—å –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–º - –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ—à–µ–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∑–∞ –≤–æ–ø—Ä–æ—Å–æ–º
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ø–æ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞

–í–û–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: ${question}

–¢–í–û–ô –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ (–∫–∞–∫ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ù–µ–π—Ä–æ–Ω–æ–≤):`;
        const result = await geminiModel.generateContent(prompt);
        const response = result.response;
        answer = response.text();
      } else {
        // Fallback response if no API keys
        answer = '–ò–∑–≤–∏–Ω–∏—Ç–µ, AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 (904) 047-63-83 –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞ aineuroexpert@gmail.com';
      }
    } catch (error) {
      console.error('AI API Error:', error);
      answer = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 (904) 047-63-83';
    }

    const responseTime = Date.now() - startTime;

    // Send Telegram notification in background
    sendTelegramNotification(question, answer, usedModel).catch(console.error);

    return NextResponse.json({
      answer,
      model: usedModel,
      responseTime
    });

  } catch (error) {
    console.error('Assistant API error:', error);
    return NextResponse.json(
      { error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' },
      { status: 500 }
    );
  }
}

// Export with rate limiting
export const POST = withRateLimit(handler, 'ai');