# Протокол x402: Техническая документация

**Автор:** Manus AI  
**Дата:** 30 сентября 2025  
**Версия:** 1.0

## 1. Введение

Протокол x402 — это открытый, децентрализованный стандарт для интернет-платежей, разработанный Coinbase. Его основная цель — обеспечить простой и безбарьерный способ монетизации веб-ресурсов и API, особенно в контексте растущей экономики AI-агентов. Протокол использует стандартный, но редко применяемый HTTP статус-код `402 Payment Required` для инициации платежного процесса, что делает его нативным для существующей веб-инфраструктуры.

Этот документ предоставляет исчерпывающее техническое описание протокола x402, его основных компонентов и принципов работы. Он предназначен для разработчиков, архитекторов и всех, кто заинтересован в интеграции современных платежных механизмов в свои приложения.

### 1.1. Ключевые преимущества

- **Нативность для HTTP:** Работает поверх существующего стека HTTP/S без необходимости в сложных SDK.
- **Блокчейн-агностицизм:** Не привязан к конкретному блокчейну или токену, обеспечивая гибкость.
- **Мгновенные расчеты:** Платежи обрабатываются со скоростью блокчейна (например, 2 секунды на Base), а не T+2 дня.
- **Отсутствие комиссий протокола:** Сам протокол не взимает комиссий ни с клиента, ни с продавца.
- **Безбарьерность:** Не требует регистрации, OAuth, API-ключей или предоставления персональных данных для совершения платежа.
- **Децентрализация и безопасность:** Является открытым стандартом, не привязанным к одному централизованному провайдеру.

## 2. Основные концепции

### 2.1. HTTP Статус-код `402 Payment Required`

Основа протокола. Когда клиент запрашивает платный ресурс, сервер отвечает этим статус-кодом. В теле ответа содержится JSON-объект с инструкциями для совершения платежа (payment details).

### 2.2. Роли

- **Клиент (Buyer):** Любое приложение, браузер или AI-агент, который хочет получить доступ к платному ресурсу.
- **Сервер (Seller):** Веб-сервер, который предоставляет платный ресурс и требует оплату за доступ.
- **Фасилитатор (Facilitator):** Опциональный, но рекомендуемый сервис (например, предоставляемый Coinbase), который упрощает процесс верификации и проведения транзакций в блокчейне. Он избавляет сервер от необходимости поддерживать собственную блокчейн-инфраструктуру.

### 2.3. Принцип работы "без состояния" (Stateless)

Каждый платежный цикл является атомарным и не требует сохранения состояния сессии. Вся необходимая информация для верификации платежа передается в заголовках одного HTTP-запроса, что идеально подходит для распределенных систем и AI-агентов.

## 3. Техническая спецификация: Платежный цикл

Платежный цикл x402 состоит из четкой последовательности шагов, основанных на стандартном HTTP request-response потоке.

![Диаграмма протокола x402](https://mintcdn.com/coinbase-prod/-uP70_EV6KGCA5Hq/x402/images/x402-protocol-flow.png?fit=max&auto=format&n=-uP70_EV6KGCA5Hq&q=85&s=d9dd623f1ff6ccc8092ab994c23c8c59)

**Шаг 1: Первичный запрос клиента**

Клиент отправляет стандартный HTTP-запрос к защищенному эндпоинту.

```http
GET /api/data HTTP/1.1
Host: neuro.expert
```

**Шаг 2: Ответ сервера `402 Payment Required`**

Сервер определяет, что ресурс платный, и отвечает статус-кодом `402`. В теле ответа содержится JSON с деталями платежа.

```http
HTTP/1.1 402 Payment Required
Content-Type: application/json

{
  "chain": "base",
  "token": "usdc",
  "to": "0xYourAddress",
  "amount": "10000", // в минимальных единицах токена
  "deadline": 1727700000
}
```

**Шаг 3: Создание и подписание транзакции клиентом**

Клиент (или его кошелек) использует полученные детали для создания и подписания блокчейн-транзакции. Результатом является подписанный `payload`.

**Шаг 4: Повторный запрос с заголовком `X-PAYMENT`**

Клиент повторяет исходный запрос, добавляя заголовок `X-PAYMENT`, содержащий подписанный `payload` в формате Base64.

```http
GET /api/data HTTP/1.1
Host: neuro.expert
X-PAYMENT: <base64_encoded_signed_payload>
```

**Шаг 5: Верификация платежа сервером (через Фасилитатора)**

Сервер получает запрос, извлекает `payload` из заголовка `X-PAYMENT` и отправляет его на эндпоинт `/verify` Фасилитатора для проверки подписи и валидности транзакции.

**Шаг 6: Проведение транзакции (Settlement)**

Если верификация прошла успешно, сервер отправляет `payload` на эндпоинт `/settle` Фасилитатора, который транслирует транзакцию в блокчейн.

**Шаг 7: Успешный ответ сервера `200 OK`**

После подтверждения транзакции в блокчейне, сервер предоставляет клиенту доступ к ресурсу, отправляя ответ `200 OK`. В ответе также содержится заголовок `X-PAYMENT-RESPONSE` с деталями проведенной транзакции (например, хэш транзакции).

```http
HTTP/1.1 200 OK
Content-Type: application/json
X-PAYMENT-RESPONSE: {"txHash": "0x..."}

{
  "data": "секретные данные, которые вы оплатили"
}
```

## 4. Сравнение с Google AP2 (Agent Payments Protocol)

x402 и AP2 не являются конкурентами, а **дополняют друг друга**. Они решают разные, но связанные задачи в экономике AI-агентов.

| Аспект | x402 | AP2 (Agent Payments Protocol) |
|---|---|---|
| **Основная задача** | Предоставление **механизма** для HTTP-платежей. | Создание **фреймворка доверия** для авторизации агентов. |
| **Фокус** | Простота и нативность для веба. | Безопасность, верификация намерений, подотчетность. |
| **Уровень абстракции** | Низкоуровневый протокол платежа. | Высокоуровневый протокол авторизации и согласия. |
| **Методы платежей** | Изначально сфокусирован на криптовалютах (USDC). | Агностик к методам платежей (карты, банковские переводы, x402). |

**Как они работают вместе:**

AP2 может использовать x402 в качестве одного из методов для фактического проведения платежа. AP2 отвечает за то, чтобы агент имел криптографически подписанное разрешение от пользователя на совершение покупки (`Intent Mandate`), а x402 предоставляет простой способ для агента оплатить эту покупку через API.

> **Вывод:** Для платформы **NeuroExpert** идеальной архитектурой будет использование **AP2** для управления разрешениями и авторизацией агентов, и **x402** как один из ключевых методов для выполнения микротранзакций и оплаты API-вызовов.

## 5. Ссылки и ресурсы

- **Официальный сайт x402:** [https://www.x402.org/](https://www.x402.org/)
- **Whitepaper x402:** [https://www.x402.org/x402-whitepaper.pdf](https://www.x402.org/x402-whitepaper.pdf)
- **Документация Coinbase по x402:** [https://docs.cdp.coinbase.com/x402/docs/welcome](https://docs.cdp.coinbase.com/x402/docs/welcome)
- **Официальный сайт AP2:** [https://ap2-protocol.org/](https://ap2-protocol.org/)
- **Сравнение AP2 и x402:** [https://ap2-protocol.org/topics/ap2-and-x402/](https://ap2-protocol.org/topics/ap2-and-x402/)
